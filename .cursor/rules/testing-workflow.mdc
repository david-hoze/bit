---
description: How to run and monitor CLI tests for the bit project
globs:
  - "test/cli/**"
  - "Bit/**/*.hs"
  - "Internal/**/*.hs"
alwaysApply: true
---

# Testing Workflow

## Fixing a Bug

When fixing a bug, use this targeted approach:

1. **Build and install:**
   ```
   cabal install --overwrite-policy=always
   ```

2. **Run only the related test(s) first:**
   ```
   shelltest test/cli/specific.test --debug
   ```
   This gives fast feedback on your fix.

3. **Once the related tests pass**, run the full test suite (see below).

## Running Full Test Suite

When running the full test suite (new features, refactors, or final verification):

1. **Build and install first:**
   ```
   cabal install --overwrite-policy=always
   ```

2. **Delete stale output** (separate step — MUST succeed before running tests):
   ```
   Remove-Item test-output.txt -ErrorAction SilentlyContinue
   ```
   This prevents reading stale results from a previous run.

3. **Run tests with shelltest** (background immediately with `block_until_ms: 0`):
   ```
   shelltest test/cli --debug > test-output.txt 2>&1
   ```

4. **Verify the command started** by reading the terminal file. Check for errors like "not recognized" or immediate exit. If the command failed to start, the output file won't exist or will be empty — do NOT proceed to monitoring without confirming the process is running.

5. **Monitor test-output.txt periodically** (every 30-60 seconds) by reading from the end of the file. Look for `[Failed]` lines.

6. **When you see a failure**, immediately start investigating and fixing it while tests continue running. Don't wait for all tests to complete.

7. **Do NOT rebuild or re-run tests after each fix.** Continue monitoring test-output.txt for additional failures and fix them all.

8. **Only after tests finish AND all fixes are complete**, do ONE final rebuild and full test run to verify everything.

## After Tests Pass

Once all tests pass, suggest a commit message:

- **One-line message** for most changes: `Fix/Add/Update <what changed>`
- **Multi-line message** only for major refactors or features that need explanation
