---
description: Guidelines for creating new CLI tests for the bit project
globs:
  - "test/cli/**"
alwaysApply: false
---

# Creating CLI Tests

## Test File Basics

CLI tests use **shelltest** (shelltestrunner) with Format 3 syntax:

```
# Comment describing the test
command to run
<<<
optional stdin input
>>>
expected stdout (literal text or /regex/)
>>>2
expected stderr (literal text or /regex/)
>>>= expected_exit_code
```

**CRITICAL FORMAT RULE**: Each directive (`<<<`, `>>>`, `>>>2`, `>>>=`) can appear **at most once per test case**. Test cases are separated by blank lines. The `lint-tests` suite enforces this rule and will fail if you use duplicate directives.

```batch
# WRONG - Multiple >>>2 directives (parse error):
command
>>>2 /error 1/
>>>2 /error 2/
>>>= 1

# CORRECT - Single >>>2 with regex alternation:
command
>>>2 /error 1|error 2/
>>>= 1

# CORRECT - Multi-line output with single >>> directive:
command
>>>
line 1
line 2
>>>= 0
```

## Directory Naming Convention

**CRITICAL: Use unique directory names per test file** to prevent test interference.

**ALL test working directories MUST be under `test\cli\output\`**

| Test File | Directory Pattern |
|-----------|-------------------|
| `gdrive-remote.test` | `test\cli\output\work_gdrive_a`, `test\cli\output\work_gdrive_b` |
| `merge-local.test` | `test\cli\output\work_merge_a`, `test\cli\output\work_merge_b`, `test\cli\output\shared_merge_remote` |
| `filesystem-remote-direct.test` | `test\cli\output\work_direct`, `test\cli\output\fs_remote_direct` |
| Generic single-repo tests | `test\cli\output\work` (shared, but cleaned up properly) |

**Pattern:** `test\cli\output\work_<testname>_a`, `test\cli\output\work_<testname>_b`, `test\cli\output\<testname>_remote`

## Required Cleanup Structure

Every test file that creates directories MUST have:

### 1. Initial Cleanup (at start of file)

```batch
# ---- CLEANUP: remove any leftover state from previous runs (timeout helps Windows release file handles) ----
timeout /t 1 >nul & rmdir /s /q test\cli\output\work_mytest_a 2>nul & rmdir /s /q test\cli\output\work_mytest_b 2>nul & echo cleanup done
<<<
>>>
cleanup done
>>>= 0
```

### 2. Final Cleanup (at end of file)

```batch
# ======================================================================
# CLEANUP
# ======================================================================

timeout /t 1 >nul & rmdir /s /q test\cli\output\work_mytest_a 2>nul & rmdir /s /q test\cli\output\work_mytest_b 2>nul & echo cleanup done
<<<
>>>
cleanup done
>>>= 0
```

### 3. Update Global Cleanup

The global cleanup in `test/cli/000-cleanup.test` removes the entire `test\cli\output\` directory, so all working directories created under `test\cli\output\` are automatically cleaned up. No need to add individual directories.

## Windows Considerations

### File Handle Timing

Always use `timeout /t 1 >nul &` before `rmdir` commands:

```batch
# Bad - may fail silently on Windows
rmdir /s /q dir 2>nul

# Good - gives Windows time to release handles
timeout /t 1 >nul & rmdir /s /q dir 2>nul
```

### Path Separators

Use backslashes for Windows paths in test commands:

```batch
cd test\cli\output\work_mytest && bit init    # Correct
cd test/cli/output/work_mytest && bit init    # May work but inconsistent
```

### Use `&&` After `cd` (Not `&`)

**CRITICAL**: In cmd.exe, `cd nonexistent & bit cmd` runs `bit cmd` even when `cd` fails â€” cmd prints an error to stderr but the `&` operator runs the next command unconditionally. This causes `bit` commands to execute in the **parent repo** (the bit project itself), contaminating its `.bit/index/.git/config` with test remotes.

Always use `&&` after `cd` so the subsequent command only runs if the directory change succeeds:

```batch
# WRONG - bit runs even if cd fails, leaking into parent repo
cd test\cli\output\work_mytest & bit remote add origin remote:path

# CORRECT - bit only runs if cd succeeds
cd test\cli\output\work_mytest && bit remote add origin remote:path
```

Note: only the first `&` (between `cd` and the first `bit` command) needs to be `&&`. Subsequent `&` separators in the same line are fine since they all run in the correct directory:

```batch
cd test\cli\output\work_mytest && echo hello> file.txt & bit add . & bit commit -m "msg"
```

### Error Suppression

Use `2>nul` only for cleanup commands where failure is acceptable. For actual test commands, let errors show:

```batch
# Cleanup - suppress errors (directory may not exist)
rmdir /s /q test\cli\output\work_mytest 2>nul

# Test command - let errors show
cd test\cli\output\work_mytest && bit init
```

## Output Matching

### Use Flexible Regex Patterns

```batch
# Good - tolerates variations
>>> /.*[Ii]nitialized.*/
>>> /\[main|master|files? changed/
>>> /Push complete|Pushing to filesystem remote/

# Bad - too strict
>>> Initialized empty bit repository in C:\Users\...
```

### Stderr vs Stdout

- Use `>>>` for stdout expectations
- Use `>>>2` for stderr expectations
- Error messages should go to stderr, success to stdout

```batch
# Expect error on stderr
cd test\cli\output\work_mytest && bit merge --abort
<<<
>>>2 /no merge in progress/
>>>= 1
```

## Test Structure Template

```batch
# =============================================================================
# <Test Name> - Brief description
#
# Longer description of what this test covers.
# Prerequisites: list any requirements (rclone, specific remotes, etc.)
# =============================================================================

# ---- CLEANUP: remove any leftover state from previous runs ----
timeout /t 1 >nul & rmdir /s /q test\cli\output\work_mytest 2>nul & echo cleanup done
<<<
>>>
cleanup done
>>>= 0

# ======================================================================
# SECTION 1: SETUP
# ======================================================================

mkdir test\cli\output\work_mytest
<<<
>>>
>>>= 0

cd test\cli\output\work_mytest && bit init
<<<
>>> /.*[Ii]nitialized.*/
>>>= 0

# ======================================================================
# SECTION 2: MAIN TEST CASES
# ======================================================================

# ---- Test case description ----
cd test\cli\output\work_mytest && bit <command>
<<<
>>> /expected output/
>>>= 0

# ======================================================================
# CLEANUP
# ======================================================================

timeout /t 1 >nul & rmdir /s /q test\cli\output\work_mytest 2>nul & echo cleanup done
<<<
>>>
cleanup done
>>>= 0
```

## Interactive Tests

For commands that prompt for input, provide stdin:

```batch
cd test\cli\output\work && bit pull
<<<
l
>>> /CONFLICT|Resolving conflicts/
>>>= 0
```

Or use non-interactive flags when available:

```batch
cd test\cli\output\work && bit pull --accept-remote
<<<
>>> /Accepting remote file state/
>>>= 0
```

## Test Execution Order

Tests run alphabetically by filename. Consider this when:
- Naming files that depend on shared state (avoid this pattern)
- Understanding why `000-cleanup.test` runs first

## Checklist for New Tests

- [ ] All directories under `test\cli\output\` (e.g., `test\cli\output\work_mytest_a`)
- [ ] Unique directory names (not `work_a`, `work_b` unless no conflicts)
- [ ] Initial cleanup with `timeout /t 1 >nul &`
- [ ] Final cleanup with `timeout /t 1 >nul &`
- [ ] Flexible regex patterns for output matching
- [ ] Errors expected on stderr use `>>>2`
- [ ] Section comments for readability
- [ ] Documented prerequisites in file header
