# =============================================================================
# Bare Init - Tests for bit init --bare and bare repo detection
#
# Covers:
# - bit init --bare creates a standard git bare repo with bit/cas/
# - Normal init creates .bit/cas/
# - Known bit commands rejected in bare repos
# - Unknown commands (passthrough) work in bare repos
# =============================================================================

# ---- CLEANUP: remove any leftover state from previous runs ----
timeout /t 1 >nul & rmdir /s /q test\cli\output\work_bare 2>nul & echo cleanup done
<<<
>>>
cleanup done
>>>= 0

# ======================================================================
# SECTION 1: BARE INIT
# ======================================================================

# ---- bit init --bare creates a standard git bare repo ----
mkdir test\cli\output\work_bare & cd test\cli\output\work_bare & bit init --bare bare.git
<<<
>>> /.*[Ii]nitialized.*/
>>>= 0

# ---- Bare repo has HEAD (standard git bare repo) ----
if exist "test\cli\output\work_bare\bare.git\HEAD" (echo exists) else (echo missing)
<<<
>>>
exists
>>>= 0

# ---- Bare repo has bit/cas/ directory ----
if exist "test\cli\output\work_bare\bare.git\bit\cas\" (echo exists) else (echo missing)
<<<
>>>
exists
>>>= 0

# ---- Bare repo has objects/ (standard git structure) ----
if exist "test\cli\output\work_bare\bare.git\objects\" (echo exists) else (echo missing)
<<<
>>>
exists
>>>= 0

# ---- Bare repo does NOT have .bit/ (not a normal bit repo) ----
if exist "test\cli\output\work_bare\bare.git\.bit\" (echo has-dotbit) else (echo no-dotbit)
<<<
>>>
no-dotbit
>>>= 0

# ======================================================================
# SECTION 2: NORMAL INIT CREATES CAS
# ======================================================================

# ---- Normal init creates .bit/cas/ ----
mkdir test\cli\output\work_bare\normal & cd test\cli\output\work_bare\normal & bit init
<<<
>>> /.*[Ii]nitialized.*/
>>>= 0

# ---- Verify .bit/cas/ exists in normal repo ----
if exist "test\cli\output\work_bare\normal\.bit\cas\" (echo exists) else (echo missing)
<<<
>>>
exists
>>>= 0

# ======================================================================
# SECTION 3: BARE REPO DETECTION
# ======================================================================

# ---- Known bit commands rejected in bare repo ----
cd test\cli\output\work_bare\bare.git & bit status
<<<
>>>2 /work tree/
>>>= 128

# ---- Git passthrough works in bare repo (e.g. git config) ----
cd test\cli\output\work_bare\bare.git & bit config core.bare
<<<
>>>
true
>>>= 0

# ======================================================================
# CLEANUP
# ======================================================================

timeout /t 1 >nul & rmdir /s /q test\cli\output\work_bare 2>nul & echo cleanup done
<<<
>>>
cleanup done
>>>= 0
