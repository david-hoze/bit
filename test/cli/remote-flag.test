# =============================================================================
# --remote Flag Test
#
# Tests the --remote <name> flag behavior.
# Workspace commands (init, add, status, commit, log, ls-files) are rejected
# for filesystem remotes. Verify and repair bypass that restriction.
# Error handling for misuse is also tested.
# Prerequisites: filesystem remote support
# =============================================================================

# ---- CLEANUP: remove any leftover state from previous runs ----
timeout /t 1 >nul & rmdir /s /q test\cli\output\work_rflag_a 2>nul & rmdir /s /q test\cli\output\fs_remote_rflag 2>nul & echo cleanup done
<<<
>>>
cleanup done
>>>= 0

# ======================================================================
# SECTION 1: SETUP
# ======================================================================

mkdir test\cli\output\fs_remote_rflag
<<<
>>>
>>>= 0

mkdir test\cli\output\work_rflag_a
<<<
>>>
>>>= 0

cd test\cli\output\work_rflag_a && bit init
<<<
>>> /.*[Ii]nitialized.*/
>>>= 0

cd test\cli\output\work_rflag_a && bit remote add origin ..\fs_remote_rflag
<<<
>>> /Remote.*added/
>>>= 0

# ======================================================================
# SECTION 2: Workspace commands rejected for filesystem remotes
# ======================================================================

# ---- --remote origin init rejected ----
cd test\cli\output\work_rflag_a && bit --remote origin init
<<<
>>>2 /Remote workspaces are only supported for cloud remotes/
>>>= 1

# ---- --remote origin add rejected ----
cd test\cli\output\work_rflag_a && bit --remote origin add .
<<<
>>>2 /Remote workspaces are only supported for cloud remotes/
>>>= 1

# ---- --remote origin status rejected ----
cd test\cli\output\work_rflag_a && bit --remote origin status
<<<
>>>2 /Remote workspaces are only supported for cloud remotes/
>>>= 1

# ---- --remote origin commit rejected ----
cd test\cli\output\work_rflag_a && bit --remote origin commit -m "test"
<<<
>>>2 /Remote workspaces are only supported for cloud remotes/
>>>= 1

# ---- --remote origin log rejected ----
cd test\cli\output\work_rflag_a && bit --remote origin log --oneline
<<<
>>>2 /Remote workspaces are only supported for cloud remotes/
>>>= 1

# ---- --remote origin ls-files rejected ----
cd test\cli\output\work_rflag_a && bit --remote origin ls-files
<<<
>>>2 /Remote workspaces are only supported for cloud remotes/
>>>= 1

# ======================================================================
# SECTION 3: ERROR CASES
# ======================================================================

# ---- --remote without argument ----
cd test\cli\output\work_rflag_a && bit --remote
<<<
>>>2 /requires a remote name argument/
>>>= 1

# ---- --remote with non-existent remote ----
cd test\cli\output\work_rflag_a && bit --remote fake init
<<<
>>>2 /remote.*not found/
>>>= 1

# ---- Unsupported command in remote context ----
cd test\cli\output\work_rflag_a && bit --remote origin push
<<<
>>>2 /not supported in remote context/
>>>= 1

# ======================================================================
# SECTION 4: verify via --remote still works for filesystem remotes
# ======================================================================

# ---- Push so remote is a valid bit repo ----
cd test\cli\output\work_rflag_a && echo test content > file.txt & bit add file.txt & bit commit -m "Initial" & bit push -u origin
<<<
>>> /Push complete/
>>>= 0

# ---- verify via --remote prefix should work ----
cd test\cli\output\work_rflag_a && bit --remote origin verify
<<<
>>> /Verifying remote files|\[OK\] All/
>>>= 0

# ======================================================================
# CLEANUP
# ======================================================================

timeout /t 1 >nul & rmdir /s /q test\cli\output\work_rflag_a 2>nul & rmdir /s /q test\cli\output\fs_remote_rflag 2>nul & echo cleanup done
<<<
>>>
cleanup done
>>>= 0
