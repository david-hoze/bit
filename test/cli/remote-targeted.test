# =============================================================================
# Remote-Targeted Commands Test
#
# Tests the @<remote> / --remote syntax for operating on remote repositories.
# Workspace commands (init, add, status, commit, log, ls-files) are rejected
# for filesystem remotes. Verify and repair bypass that restriction.
# Error handling is also tested.
# Prerequisites: filesystem remote support
# =============================================================================

# ---- CLEANUP: remove any leftover state from previous runs ----
timeout /t 1 >nul & rmdir /s /q test\cli\output\work_rmt_a 2>nul & rmdir /s /q test\cli\output\fs_remote_rmt 2>nul & echo cleanup done
<<<
>>>
cleanup done
>>>= 0

# ======================================================================
# SECTION 1: SETUP
# ======================================================================

mkdir test\cli\output\fs_remote_rmt
<<<
>>>
>>>= 0

mkdir test\cli\output\work_rmt_a
<<<
>>>
>>>= 0

cd test\cli\output\work_rmt_a && bit init
<<<
>>> /.*[Ii]nitialized.*/
>>>= 0

cd test\cli\output\work_rmt_a && bit remote add origin ..\fs_remote_rmt
<<<
>>> /Remote.*added/
>>>= 0

# ======================================================================
# SECTION 2: @remote workspace commands rejected for filesystem remotes
# ======================================================================

# ---- @origin init rejected ----
cd test\cli\output\work_rmt_a && bit @origin init
<<<
>>>2 /Remote workspaces are only supported for cloud remotes/
>>>= 1

# ---- Verify NO persistent workspace was created ----
cd test\cli\output\work_rmt_a && if exist .bit\remote-workspaces\origin\.git (echo workspace exists) else (echo no workspace)
<<<
>>>
no workspace
>>>= 0

# ---- @origin add rejected ----
cd test\cli\output\work_rmt_a && bit @origin add .
<<<
>>>2 /Remote workspaces are only supported for cloud remotes/
>>>= 1

# ---- @nonexistent add error (remote not found) ----
cd test\cli\output\work_rmt_a && bit @nonexistent add .
<<<
>>>2 /not found/
>>>= 1

# ---- @origin status rejected ----
cd test\cli\output\work_rmt_a && bit @origin status
<<<
>>>2 /Remote workspaces are only supported for cloud remotes/
>>>= 1

# ---- @origin log rejected ----
cd test\cli\output\work_rmt_a && bit @origin log --oneline
<<<
>>>2 /Remote workspaces are only supported for cloud remotes/
>>>= 1

# ---- @origin ls-files rejected ----
cd test\cli\output\work_rmt_a && bit @origin ls-files
<<<
>>>2 /Remote workspaces are only supported for cloud remotes/
>>>= 1

# ---- --remote origin ls-files also rejected ----
cd test\cli\output\work_rmt_a && bit --remote origin ls-files
<<<
>>>2 /Remote workspaces are only supported for cloud remotes/
>>>= 1

# ---- @origin commit rejected ----
cd test\cli\output\work_rmt_a && bit @origin commit -m "test"
<<<
>>>2 /Remote workspaces are only supported for cloud remotes/
>>>= 1

# ---- --remote origin status also rejected ----
cd test\cli\output\work_rmt_a && bit --remote origin status
<<<
>>>2 /Remote workspaces are only supported for cloud remotes/
>>>= 1

# ---- --remote origin log also rejected ----
cd test\cli\output\work_rmt_a && bit --remote origin log --oneline
<<<
>>>2 /Remote workspaces are only supported for cloud remotes/
>>>= 1

# ======================================================================
# SECTION 3: ERROR CASES
# ======================================================================

# ---- Unsupported command in remote context ----
cd test\cli\output\work_rmt_a && bit @origin push
<<<
>>>2 /not supported in remote context/
>>>= 1

# ---- Non-existent remote ----
cd test\cli\output\work_rmt_a && bit @fake init
<<<
>>>2 /remote.*not found/
>>>= 1

# ---- @remote commands from subdirectory (finds parent repo via findBitRoot) ----
mkdir test\cli\output\work_rmt_a\notrepo
<<<
>>>
>>>= 0

cd test\cli\output\work_rmt_a\notrepo && bit @origin init
<<<
>>>2 /Remote workspaces are only supported for cloud remotes/
>>>= 1

# ======================================================================
# CLEANUP
# ======================================================================

timeout /t 1 >nul & rmdir /s /q test\cli\output\work_rmt_a 2>nul & rmdir /s /q test\cli\output\fs_remote_rmt 2>nul & echo cleanup done
<<<
>>>
cleanup done
>>>= 0
