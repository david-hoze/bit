# =============================================================================
# Submodule Gitlink - Verify scanner and bit add handle subrepos correctly
#
# The scanner treats directories containing .git/ or .bit/ as opaque
# boundaries and does not descend into them. To register a subrepo with
# the parent, use `bit add <path>` which moves the .git/ directory to
# .bit/index/ and lets git create the 160000 entry.
# .git DIRECTORIES inside subdirectories make the entire subdirectory an
# opaque boundary for the scanner. .git files (gitlinks) in already-
# registered submodules are still allowed through.
# =============================================================================

# ---- CLEANUP: remove any leftover state from previous runs ----
timeout /t 1 >nul & rmdir /s /q test\cli\output\work_submodule 2>nul & echo cleanup done
<<<
>>>
cleanup done
>>>= 0

# ======================================================================
# SETUP
# ======================================================================

mkdir test\cli\output\work_submodule
<<<
>>>= 0

cd test\cli\output\work_submodule && bit init
<<<
>>> /.*[Ii]nitialized.*/
>>>= 0

# ======================================================================
# SECTION 1: Create a submodule-like directory with .git gitlink file
# ======================================================================

# ---- Create subdirectory, init git, rename .git dir to .real, write gitlink file ----
bash -c "cd test/cli/output/work_submodule && mkdir sub && cd sub && git init && mv .git .real && echo 'gitdir: .real' > .git && echo content > file.txt && git add file.txt && git commit -m first"
<<<
>>> /.*[Ii]nitialized.*/
>>>= 0

# ---- Create a regular file in the parent repo ----
cd test\cli\output\work_submodule && echo toplevel> top.txt
<<<
>>>= 0

# ======================================================================
# SECTION 2: bit add registers the subrepo with 160000 entry
# ======================================================================

# ---- bit add top.txt first (scanner handles regular files) ----
cd test\cli\output\work_submodule && bit add top.txt
<<<
>>>= 0

# ---- bit add sub registers the subrepo (moves .real to index, git sees it) ----
# Note: sub has .git file (gitlink) not directory, and .real/ directory.
# The scanner treats sub/ as having a gitlink, not a .git/ directory, so
# sub/ is NOT a subrepo boundary. The gitlink file is allowed through.
cd test\cli\output\work_submodule && bit add sub
<<<
>>>= 0

# ---- Verify git sees mode 160000 for the submodule ----
cd test\cli\output\work_submodule && bit ls-files --stage sub
<<<
>>> /160000/
>>>= 0

# ---- Commit the submodule entry ----
cd test\cli\output\work_submodule && bit commit -m "Add submodule"
<<<
>>> /\[main|master|files? changed/
>>>= 0

# ======================================================================
# SECTION 3: .git DIRECTORIES make dirs opaque (regression check)
# ======================================================================

# ---- Create another subdir with a .git DIRECTORY (not a gitlink) ----
bash -c "cd test/cli/output/work_submodule && mkdir nested && cd nested && git init && echo nested-file > data.txt && git add . && git commit -m first"
<<<
>>> /.*[Ii]nitialized.*/
>>>= 0

# ---- bit add nested registers as subrepo (moves .git/ to index) ----
cd test\cli\output\work_submodule && bit add nested
<<<
>>>= 0

# ---- nested/ should have a 160000 entry (subrepo) ----
cd test\cli\output\work_submodule && bit ls-files --stage nested
<<<
>>> /160000/
>>>= 0

# ======================================================================
# CLEANUP
# ======================================================================

timeout /t 1 >nul & rmdir /s /q test\cli\output\work_submodule 2>nul & echo cleanup done
<<<
>>>
cleanup done
>>>= 0
