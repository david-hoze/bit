# Network Remote Tests
# Tests bit push/verify/repair to a UNC network path (\\tsclient\c\users\david\bit-testing).
# Uses rclone copy to batch-stage the remote and rclone purge for fast cleanup.

# ---- CLEANUP ----
timeout /t 1 >nul & rmdir /s /q test\cli\output\work_network 2>nul & rclone purge \\tsclient\c\users\david\bit-testing 2>nul & echo cleanup done
<<<
>>>
cleanup done
>>>= 0

# ======================================================================
# SETUP: create repo locally, batch-copy to UNC, add remote
# ======================================================================

mkdir test\cli\output\work_network
<<<
>>>
>>>= 0

cd test\cli\output\work_network && bit init
<<<
>>> /.*[Ii]nitialized.*/
>>>= 0

cd test\cli\output\work_network && echo binary data> data.bin & echo hello world> greet.txt & bit add data.bin greet.txt & bit commit -m "Initial commit"
<<<
>>> /\[main|files? changed/
>>>= 0

# Batch-copy entire repo to UNC (rclone batches all .bit/index/.git/ files in one pass)
mkdir \\tsclient\c\users\david\bit-testing & rclone copy test\cli\output\work_network \\tsclient\c\users\david\bit-testing
<<<
>>>
>>>= 0

cd test\cli\output\work_network && bit remote add origin \\tsclient\c\users\david\bit-testing
<<<
>>> /Remote 'origin' added/
>>>= 0

# Fetch + push to sync tracking refs (remote already has content, push is a no-op)
cd test\cli\output\work_network && bit fetch & bit push -u origin
<<<
>>> /Push complete/
>>>= 0

# ======================================================================
# TEST: Files arrived at network remote
# ======================================================================

if exist "\\tsclient\c\users\david\bit-testing\data.bin" (echo data exists) else (echo missing)
<<<
>>>
data exists
>>>= 0

if exist "\\tsclient\c\users\david\bit-testing\greet.txt" (echo greet exists) else (echo missing)
<<<
>>>
greet exists
>>>= 0

# ======================================================================
# TEST: bit status shows up-to-date after push
# ======================================================================

cd test\cli\output\work_network && bit status
<<<
>>> /up to date/
>>>= 0

# ======================================================================
# TEST: Modify locally, push to UNC
# ======================================================================

cd test\cli\output\work_network && echo updated binary> data.bin & bit add data.bin & bit commit -m "Update data"
<<<
>>> /\[main|files? changed/
>>>= 0

cd test\cli\output\work_network && bit push
<<<
>>> /Push complete/
>>>= 0

# ======================================================================
# TEST: Verify against network remote
# ======================================================================

cd test\cli\output\work_network && bit verify
<<<
>>> /\[OK\] All.*files match/
>>>= 0

# ======================================================================
# TEST: Repair from network remote
# ======================================================================

cd test\cli\output\work_network && echo corrupted> data.bin
<<<
>>>
>>>= 0

cd test\cli\output\work_network && bit repair
<<<
>>> /REPAIRED.*data\.bin/
>>>= 0

cd test\cli\output\work_network && bit verify
<<<
>>> /\[OK\] All.*files match/
>>>= 0

# ======================================================================
# CLEANUP
# ======================================================================

timeout /t 1 >nul & rmdir /s /q test\cli\output\work_network 2>nul & rclone purge \\tsclient\c\users\david\bit-testing 2>nul & echo cleanup done
<<<
>>>
cleanup done
>>>= 0
