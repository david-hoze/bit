# =============================================================================
# Layout + Mode matrix tests (spec: full/lite, full/solid)
#
# Tests each combination that can be tested with filesystem remote:
#   - Full + lite: add, push, pull, merge, conflict (manual-merge)
#   - Full + solid: add, push, pull, merge, conflict (manual-merge)
#
# Bare + lite and bare + solid require cloud (see gdrive-remote.test) or
# a local rclone remote; bare add/show are in bare-remote.test.
# =============================================================================

# ---- CLEANUP ----
timeout /t 1 >nul & rmdir /s /q test\cli\output\work_ml_lite_local 2>nul & rmdir /s /q test\cli\output\work_ml_lite_remote 2>nul & rmdir /s /q test\cli\output\work_ml_solid_local 2>nul & rmdir /s /q test\cli\output\work_ml_solid_remote 2>nul & echo cleanup done
<<<
>>>
cleanup done
>>>= 0

# ======================================================================
# FULL + LITE
# ======================================================================

mkdir test\cli\output\work_ml_lite_local
<<<
>>>
>>>= 0

mkdir test\cli\output\work_ml_lite_remote
<<<
>>>
>>>= 0

cd test\cli\output\work_ml_lite_local & bit init
<<<
>>> /.*[Ii]nitialized.*/
>>>= 0

cd test\cli\output\work_ml_lite_local & bit config core.mode lite
<<<
>>> /[Mm]ode set to lite|lite/
>>>= 0

cd test\cli\output\work_ml_lite_local & bit remote add origin ..\work_ml_lite_remote
<<<
>>> /Remote.*added/
>>>= 0

cd test\cli\output\work_ml_lite_local & echo lite content> file.txt & echo bin> x.bin & bit add file.txt x.bin & bit commit -m "Add files"
<<<
>>> /\[main|files? changed/
>>>= 0

cd test\cli\output\work_ml_lite_local & bit push -u origin
<<<
>>> /Push complete/
>>>= 0

cd test\cli\output\work_ml_lite_remote & bit status
<<<
>>> /nothing to commit|On branch/
>>>= 0

mkdir test\cli\output\work_ml_lite_b
<<<
>>>
>>>= 0

cd test\cli\output\work_ml_lite_b & bit init & bit config core.mode lite & bit remote add origin ..\work_ml_lite_remote
<<<
>>> /.*[Ii]nitialized.*/
>>>= 0

cd test\cli\output\work_ml_lite_b & bit fetch & bit pull origin
<<<
>>> /first pull|Checking out|Syncing|Merge made|Pulling/
>>>= 0

cd test\cli\output\work_ml_lite_b & findstr /C:"lite content" .bit\index\file.txt >nul
<<<
>>>
>>>= 0

cd test\cli\output\work_ml_lite_b & echo from B> b.txt & bit add b.txt & bit commit -m "Add b" & bit push origin
<<<
>>> /Push complete/
>>>= 0

cd test\cli\output\work_ml_lite_local & echo from A> a.txt & bit add a.txt & bit commit -m "Add a" & bit pull origin
<<<
>>> /Merge made|Updating|Syncing/
>>>= 0

cd test\cli\output\work_ml_lite_local & if exist a.txt (echo a) else (echo no)
<<<
>>>
a
>>>= 0

cd test\cli\output\work_ml_lite_local & if exist b.txt (echo b) else (echo no)
<<<
>>>
b
>>>= 0

cd test\cli\output\work_ml_lite_remote & echo bad> x.bin
<<<
>>>
>>>= 0

cd test\cli\output\work_ml_lite_remote & echo new> new.bin & bit add new.bin & bit commit -m "Remote add"
<<<
>>> /.*changed/
>>>= 0

cd test\cli\output\work_ml_lite_local & bit pull origin --manual-merge
<<<
>>> /Remote divergence|conflicts|No remote divergence|Proceeding with normal pull/
>>>= 0

# ======================================================================
# FULL + SOLID
# ======================================================================

mkdir test\cli\output\work_ml_solid_local
<<<
>>>
>>>= 0

mkdir test\cli\output\work_ml_solid_remote
<<<
>>>
>>>= 0

cd test\cli\output\work_ml_solid_local & bit init
<<<
>>> /.*[Ii]nitialized.*/
>>>= 0

cd test\cli\output\work_ml_solid_local & bit config core.mode solid
<<<
>>> /[Ss]olid|Mode set/
>>>= 0

cd test\cli\output\work_ml_solid_local & bit remote add origin ..\work_ml_solid_remote
<<<
>>> /Remote.*added/
>>>= 0

cd test\cli\output\work_ml_solid_local & echo solid content> file.txt & echo bin> x.bin & bit add file.txt x.bin & bit commit -m "Add files"
<<<
>>> /\[main|files? changed/
>>>= 0

cd test\cli\output\work_ml_solid_local & bit push -u origin
<<<
>>> /Push complete/
>>>= 0

mkdir test\cli\output\work_ml_solid_b
<<<
>>>
>>>= 0

cd test\cli\output\work_ml_solid_b & bit init & bit config core.mode solid & bit remote add origin ..\work_ml_solid_remote
<<<
>>> /.*[Ii]nitialized.*/
>>>= 0

cd test\cli\output\work_ml_solid_b & bit fetch & bit pull origin
<<<
>>> /first pull|Checking out|Syncing|Merge made|Pulling/
>>>= 0

cd test\cli\output\work_ml_solid_b & findstr /C:"solid content" .bit\index\file.txt >nul
<<<
>>>
>>>= 0

cd test\cli\output\work_ml_solid_b & echo from B> b.txt & bit add b.txt & bit commit -m "Add b" & bit push origin
<<<
>>> /Push complete/
>>>= 0

cd test\cli\output\work_ml_solid_local & echo from A> a.txt & bit add a.txt & bit commit -m "Add a" & bit pull origin
<<<
>>> /Merge made|Updating|Syncing/
>>>= 0

cd test\cli\output\work_ml_solid_local & if exist a.txt (echo a) else (echo no)
<<<
>>>
a
>>>= 0

cd test\cli\output\work_ml_solid_local & if exist b.txt (echo b) else (echo no)
<<<
>>>
b
>>>= 0

cd test\cli\output\work_ml_solid_remote & echo bad> x.bin
<<<
>>>
>>>= 0

cd test\cli\output\work_ml_solid_remote & echo new> new.bin & bit add new.bin & bit commit -m "Remote add"
<<<
>>> /.*changed/
>>>= 0

cd test\cli\output\work_ml_solid_local & bit pull origin --manual-merge
<<<
>>> /Remote divergence|conflicts|No remote divergence|Proceeding with normal pull/
>>>= 0

# ======================================================================
# CLEANUP
# ======================================================================

timeout /t 1 >nul & rmdir /s /q test\cli\output\work_ml_lite_local 2>nul & rmdir /s /q test\cli\output\work_ml_lite_remote 2>nul & rmdir /s /q test\cli\output\work_ml_lite_b 2>nul & rmdir /s /q test\cli\output\work_ml_solid_local 2>nul & rmdir /s /q test\cli\output\work_ml_solid_remote 2>nul & rmdir /s /q test\cli\output\work_ml_solid_b 2>nul & echo cleanup done
<<<
>>>
cleanup done
>>>= 0
