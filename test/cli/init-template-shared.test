# =============================================================================
# Init Template & Shared - Verify --template path resolution, --shared flag,
# GIT_DIR=/dev/null bypass, and .git junction passthrough
#
# Tests that:
# 1. --template with relative path resolves correctly (not relative to .bit/index)
# 2. --shared and core.sharedRepository flags pass through to git
# 3. GIT_DIR=/dev/null passes through to git without .bit interception
# 4. git config -f <relative-path> works through .git junction passthrough
# =============================================================================

# ---- CLEANUP: remove any leftover state from previous runs ----
timeout /t 1 >nul & rmdir /s /q test\cli\output\work_inittpl 2>nul & rmdir /s /q test\cli\output\tpl_source 2>nul & echo cleanup done
<<<
>>>
cleanup done
>>>= 0

# ======================================================================
# SETUP
# ======================================================================

mkdir test\cli\output\work_inittpl
<<<
>>>= 0

# ======================================================================
# SECTION 1: Template path resolution
# ======================================================================

# ---- Create a template source directory with a custom hook file ----
mkdir test\cli\output\tpl_source & mkdir test\cli\output\tpl_source\hooks & echo custom-hook> test\cli\output\tpl_source\hooks\pre-commit.sample
<<<
>>>= 0

# ---- Init with --template= pointing to relative path ----
cd test\cli\output\work_inittpl && bit init -q --template=..\tpl_source repo_tpl1
<<<
>>> /.*[Ii]nitialized.*/
>>>= 0

# ---- Template hook was copied into the repo ----
if exist "test\cli\output\work_inittpl\repo_tpl1\.bit\index\.git\hooks\pre-commit.sample" (echo TEMPLATE_COPIED) else (echo TEMPLATE_MISSING)
<<<
>>>
TEMPLATE_COPIED
>>>= 0

# ---- Init with --template <space> form ----
cd test\cli\output\work_inittpl && bit init -q --template ..\tpl_source repo_tpl2
<<<
>>> /.*[Ii]nitialized.*/
>>>= 0

# ---- Template hook was copied (space form) ----
if exist "test\cli\output\work_inittpl\repo_tpl2\.bit\index\.git\hooks\pre-commit.sample" (echo TEMPLATE_COPIED) else (echo TEMPLATE_MISSING)
<<<
>>>
TEMPLATE_COPIED
>>>= 0

# ---- Init with blank --template= (no templates copied) ----
cd test\cli\output\work_inittpl && bit init -q --template= repo_tpl3
<<<
>>> /.*[Ii]nitialized.*/
>>>= 0

# ---- Blank template means no default hooks ----
if exist "test\cli\output\work_inittpl\repo_tpl3\.bit\index\.git\hooks\pre-commit.sample" (echo HAS_HOOK) else (echo NO_HOOK)
<<<
>>>
NO_HOOK
>>>= 0

# ======================================================================
# SECTION 2: --shared flag passthrough
# ======================================================================

# ---- Init with --shared=group ----
cd test\cli\output\work_inittpl && bit init -q --shared=group repo_shared
<<<
>>> /.*[Ii]nitialized.*/
>>>= 0

# ---- core.sharedRepository should be set ----
cd test\cli\output\work_inittpl\repo_shared && bit config core.sharedRepository
<<<
>>> /1|group|true/
>>>= 0

# ======================================================================
# SECTION 3: GIT_DIR=/dev/null bypass
# ======================================================================

# ---- Create two temp files to diff ----
echo file-a> test\cli\output\work_inittpl\a.txt & echo file-b> test\cli\output\work_inittpl\b.txt
<<<
>>>= 0

# ---- GIT_DIR=/dev/null bit diff --no-index should work (exit 1 = files differ) ----
cd test\cli\output\work_inittpl && set "GIT_DIR=/dev/null" & bit diff --no-index --stat a.txt b.txt
<<<
>>> /a\.txt.*b\.txt/
>>>= 1

# ======================================================================
# SECTION 4: .git gitlink passthrough (config -f with --separate-git-dir)
# ======================================================================

# ---- Create a repo with --separate-git-dir (creates .git gitlink file) ----
mkdir test\cli\output\work_inittpl\sgdir_db
<<<
>>>= 0

cd test\cli\output\work_inittpl && bit init -q --separate-git-dir test\cli\output\work_inittpl\sgdir_db repo_junc
<<<
>>> /.*[Ii]nitialized.*/
>>>= 0

# ---- .git should be a file (gitlink), not directory ----
cd test\cli\output\work_inittpl\repo_junc && if exist .git (if exist .git\NUL (echo IS_DIR) else (echo IS_FILE)) else (echo NO_GIT)
<<<
>>>
IS_FILE
>>>= 0

# ---- Write a custom config file in CWD ----
cd test\cli\output\work_inittpl\repo_junc && echo [test]> custom.cfg & echo     value = hello>> custom.cfg
<<<
>>>= 0

# ---- bit config -f custom.cfg should read relative to CWD, not .bit/index ----
cd test\cli\output\work_inittpl\repo_junc && bit config -f custom.cfg test.value
<<<
>>>
hello
>>>= 0

# ======================================================================
# CLEANUP
# ======================================================================

timeout /t 1 >nul & rmdir /s /q test\cli\output\work_inittpl 2>nul & rmdir /s /q test\cli\output\tpl_source 2>nul & echo cleanup done
<<<
>>>
cleanup done
>>>= 0
