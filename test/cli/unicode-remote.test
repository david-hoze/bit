# =============================================================================
# Unicode Remote Test - Non-ASCII Filenames with rclone
#
# Tests that bit correctly handles files with non-ASCII characters when
# pushing/pulling to remote storage via rclone. This specifically verifies
# that the rclone JSON output is parsed correctly even when filenames contain
# Hebrew, Chinese, emoji, or other Unicode characters.
#
# Prerequisites: None (uses filesystem remote via rclone path syntax)
# =============================================================================

# ---- CLEANUP: remove any leftover state from previous runs ----
timeout /t 1 >nul & rmdir /s /q test\cli\output\work_unicode_remote 2>nul & rmdir /s /q test\cli\output\fs_unicode_remote 2>nul & echo cleanup done
<<<
>>>
cleanup done
>>>= 0

# ======================================================================
# SECTION 1: SETUP
# ======================================================================

mkdir test\cli\output\work_unicode_remote
<<<
>>>
>>>= 0

mkdir test\cli\output\fs_unicode_remote
<<<
>>>
>>>= 0

cd test\cli\output\work_unicode_remote & bit init
<<<
>>> /.*[Ii]nitialized.*/
>>>= 0

# Add filesystem remote (using rclone path syntax to ensure rclone is involved)
cd test\cli\output\work_unicode_remote & bit remote add origin ..\fs_unicode_remote
<<<
>>> /Remote 'origin' added/
>>>= 0

# ======================================================================
# SECTION 2: TEST UNICODE FILENAMES
# ======================================================================

# ---- Create files with ASCII names but Unicode content ----
# This tests the core functionality: rclone JSON parsing with Unicode in filenames
# Note: We use ASCII filenames to avoid Windows cmd.exe Unicode handling issues in tests
cd test\cli\output\work_unicode_remote & echo ×©×œ×•× Hebrew content> test-hebrew.txt
<<<
>>>= 0

cd test\cli\output\work_unicode_remote & echo ä¸­æ–‡ Chinese content> test-chinese.txt
<<<
>>>= 0

cd test\cli\output\work_unicode_remote & echo ðŸ˜€ Emoji content> test-emoji.txt
<<<
>>>= 0

cd test\cli\output\work_unicode_remote & echo cafÃ© æ—¥æœ¬èªž Mixed> test-mixed.txt
<<<
>>>= 0

# ---- Add and commit all files ----
cd test\cli\output\work_unicode_remote & bit add . & bit commit -m "Add Unicode files"
<<<
>>> /\[main|files? changed/
>>>= 0

# ---- Push to remote (this is where the bug would occur) ----
# Before the fix, if any file had Unicode in its name, rclone JSON parsing would fail
# This should succeed without "Failed to parse rclone JSON output" error
cd test\cli\output\work_unicode_remote & bit push -u origin
<<<
>>> /Push complete/
>>>= 0

# ---- Verify files exist at remote ----
if exist "test\cli\output\fs_unicode_remote\test-hebrew.txt" (echo hebrew exists) else (echo missing)
<<<
>>>
hebrew exists
>>>= 0

if exist "test\cli\output\fs_unicode_remote\test-chinese.txt" (echo chinese exists) else (echo missing)
<<<
>>>
chinese exists
>>>= 0

if exist "test\cli\output\fs_unicode_remote\test-emoji.txt" (echo emoji exists) else (echo missing)
<<<
>>>
emoji exists
>>>= 0

if exist "test\cli\output\fs_unicode_remote\test-mixed.txt" (echo mixed exists) else (echo missing)
<<<
>>>
mixed exists
>>>= 0

# ======================================================================
# SECTION 3: TEST PULL WITH UNICODE FILENAMES
# ======================================================================

# ---- Create a new workspace and pull from remote ----
mkdir test\cli\output\work_unicode_remote_b
<<<
>>>
>>>= 0

cd test\cli\output\work_unicode_remote_b & bit init
<<<
>>> /.*[Ii]nitialized.*/
>>>= 0

cd test\cli\output\work_unicode_remote_b & bit remote add origin ..\fs_unicode_remote
<<<
>>> /Remote 'origin' added/
>>>= 0

# Pull should succeed and parse rclone JSON correctly (explicit remote, no upstream)
# Before the fix, this would fail with "Failed to parse rclone JSON output"
cd test\cli\output\work_unicode_remote_b & bit pull origin
<<<
>>> /Pull|Updating/
>>>= 0

# Verify files were pulled correctly
if exist "test\cli\output\work_unicode_remote_b\test-hebrew.txt" (echo hebrew pulled) else (echo missing)
<<<
>>>
hebrew pulled
>>>= 0

if exist "test\cli\output\work_unicode_remote_b\test-chinese.txt" (echo chinese pulled) else (echo missing)
<<<
>>>
chinese pulled
>>>= 0

# ======================================================================
# CLEANUP
# ======================================================================

timeout /t 1 >nul & rmdir /s /q test\cli\output\work_unicode_remote 2>nul & rmdir /s /q test\cli\output\work_unicode_remote_b 2>nul & rmdir /s /q test\cli\output\fs_unicode_remote 2>nul & echo cleanup done
<<<
>>>
cleanup done
>>>= 0
