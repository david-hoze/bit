# =============================================================================
# Bare remote push/pull (requires rclone remote "gdrive-test")
#
# Uses gdrive-test:bit-test-bare (separate path from gdrive-remote.test).
# Tests: bare + lite (add, push, pull), bare + solid (add, push, pull).
# Merge/conflict on bare use same metadata merge as full; file sync is from CAS.
# =============================================================================

# ---- CLEANUP and create bare path on cloud ----
timeout /t 1 >nul & rmdir /s /q test\cli\output\work_bare_a 2>nul & rmdir /s /q test\cli\output\work_bare_b 2>nul & rclone purge gdrive-test:bit-test-bare 2>nul & rclone mkdir gdrive-test:bit-test-bare 2>nul & echo cleanup done
<<<
>>>
cleanup done
>>>= 0

# ======================================================================
# BARE + LITE: push and pull
# ======================================================================

mkdir test\cli\output\work_bare_a
<<<
>>>
>>>= 0

cd test\cli\output\work_bare_a & bit init
<<<
>>> /.*[Ii]nitialized.*/
>>>= 0

cd test\cli\output\work_bare_a & bit config core.mode lite
<<<
>>> /[Mm]ode set to lite|lite/
>>>= 0

cd test\cli\output\work_bare_a & bit remote add origin gdrive-test:bit-test-bare --bare
<<<
>>> /Remote.*added.*bare layout/
>>>= 0

cd test\cli\output\work_bare_a & echo bare lite content> file.txt & echo bin> x.bin & bit add file.txt x.bin & bit commit -m "Add files"
<<<
>>> /\[main|files? changed/
>>>= 0

cd test\cli\output\work_bare_a & bit push -u origin
<<<
>>> /Remote is empty|Inspecting remote|Push complete|Pushing/
>>>= 0

mkdir test\cli\output\work_bare_b
<<<
>>>
>>>= 0

cd test\cli\output\work_bare_b & bit init & bit config core.mode lite & bit remote add origin gdrive-test:bit-test-bare --bare
<<<
>>> /.*[Ii]nitialized.*/
>>>= 0

cd test\cli\output\work_bare_b & bit fetch & bit pull origin
<<<
>>> /first pull|Checking out|Syncing|Merge made|Pulling|remote: Counting/
>>>= 0

cd test\cli\output\work_bare_b & findstr /C:"bare lite content" .bit\index\file.txt >nul
<<<
>>>
>>>= 0

# ======================================================================
# BARE + SOLID: push and pull
# ======================================================================

cd test\cli\output\work_bare_a & bit config core.mode solid
<<<
>>> /[Ss]olid|Mode set/
>>>= 0

cd test\cli\output\work_bare_a & echo solid add> y.bin & bit add y.bin & bit commit -m "Add y" & bit push origin
<<<
>>> /Push complete/
>>>= 0

cd test\cli\output\work_bare_b & bit config core.mode solid & bit pull origin
<<<
>>> /Merge made|Updating|Syncing|already up to date/
>>>= 0

cd test\cli\output\work_bare_b & if exist y.bin (echo y) else (echo no)
<<<
>>>
y
>>>= 0

# ======================================================================
# CLEANUP
# ======================================================================

timeout /t 1 >nul & rmdir /s /q test\cli\output\work_bare_a 2>nul & rmdir /s /q test\cli\output\work_bare_b 2>nul & rclone purge gdrive-test:bit-test-bare 2>nul & echo cleanup done
<<<
>>>
cleanup done
>>>= 0
