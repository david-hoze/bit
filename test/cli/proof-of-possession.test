# =============================================================================
# Proof of Possession Tests
#
# Tests the proof of possession rule: push/pull must verify that working tree
# matches metadata before transferring metadata.
#
# Covers:
# - Push verification blocks when a tracked file is missing from working tree
# - Pull verification blocks when remote files don't match remote metadata
# - --skip-verify bypasses verification on pull
# - --force bypasses verification on push
# - --accept-remote bypasses verification on pull
# =============================================================================

# ---- CLEANUP: remove any leftover state from previous runs ----
timeout /t 1 >nul & rmdir /s /q test\cli\output\work_pop_local 2>nul & rmdir /s /q test\cli\output\work_pop_remote 2>nul & echo cleanup done
<<<
>>>
cleanup done
>>>= 0

# ======================================================================
# SECTION 1: SETUP
# ======================================================================

mkdir test\cli\output\work_pop_local
<<<
>>>
>>>= 0

cd test\cli\output\work_pop_local & bit init
<<<
>>> /.*[Ii]nitialized.*/
>>>= 0

# ---- Create a test file and commit it ----
cd test\cli\output\work_pop_local & echo original content > file.txt & bit add file.txt
<<<
>>>
>>>= 0

cd test\cli\output\work_pop_local & bit commit -m "Initial commit"
<<<
>>> /.*1 file changed.*/
>>>= 0

# ---- Set up filesystem remote ----
mkdir test\cli\output\work_pop_remote
<<<
>>>
>>>= 0

cd test\cli\output\work_pop_local & bit remote add origin ..\work_pop_remote
<<<
>>> /Remote.*added/
>>>= 0

# ---- First push should succeed (everything matches) ----
cd test\cli\output\work_pop_local & bit push -u origin
<<<
>>> /Push complete/
>>>= 0

# ======================================================================
# SECTION 2: PUSH VERIFICATION - Tracked file must exist in working tree
# ======================================================================

# ---- Delete tracked file (metadata remains in .bit/index) - push should fail ----
cd test\cli\output\work_pop_local & del file.txt & bit push
<<<
>>> /Verifying local files/
>>>2 /Working tree does not match metadata/
>>>= 1

# ---- Verify --force bypasses verification on push ----
cd test\cli\output\work_pop_local & echo original content > file.txt & bit push --force
<<<
>>> /Push|Pushing to filesystem remote/
>>>= 0

# ======================================================================
# SECTION 3: PULL VERIFICATION - Remote files must match remote metadata
# ======================================================================

# ---- Corrupt file at remote - pull should fail ----
cd test\cli\output\work_pop_remote & echo corrupted content > file.txt & cd ..\work_pop_local & bit pull
<<<
>>> /Verifying remote/
>>>2 /Remote working tree does not match remote metadata/
>>>= 1

# ---- Verify --skip-verify bypasses verification on pull ----
cd test\cli\output\work_pop_local & bit pull --skip-verify
<<<
>>> /Pull|Fetching remote commits/
>>>= 0

# ---- Verify --accept-remote bypasses verification (after re-corrupting remote) ----
cd test\cli\output\work_pop_remote & echo corrupted again > file.txt & cd ..\work_pop_local & bit pull origin --accept-remote
<<<
>>> /Accepting remote file state/
>>>= 0

# ======================================================================
# CLEANUP
# ======================================================================

timeout /t 1 >nul & rmdir /s /q test\cli\output\work_pop_local 2>nul & rmdir /s /q test\cli\output\work_pop_remote 2>nul & echo cleanup done
<<<
>>>
cleanup done
>>>= 0
