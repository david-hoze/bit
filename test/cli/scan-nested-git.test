# =============================================================================
# Scan Nested .git - Verify scan treats subrepo dirs as opaque boundaries
#
# The scanner must not descend into directories containing .git/ or .bit/.
# These are subrepo boundaries â€” their contents are managed independently.
# Only top-level files outside subrepo boundaries should be scanned.
# =============================================================================

# ---- CLEANUP: remove any leftover state from previous runs ----
timeout /t 1 >nul & rmdir /s /q test\cli\output\work_scannested 2>nul & echo cleanup done
<<<
>>>
cleanup done
>>>= 0

# ======================================================================
# SETUP
# ======================================================================

mkdir test\cli\output\work_scannested
<<<
>>>= 0

cd test\cli\output\work_scannested & bit init
<<<
>>> /.*[Ii]nitialized.*/
>>>= 0

# ======================================================================
# SECTION 1: Create a subdirectory with its own .git
# ======================================================================

# ---- Create a subdir with a nested git repo (simulates git init inside project) ----
cd test\cli\output\work_scannested & mkdir subdir & cd subdir & git init
<<<
>>> /.*[Ii]nitialized.*/
>>>= 0

# ---- Create a file in the main repo and one inside the nested git repo ----
cd test\cli\output\work_scannested & echo toplevel> file.txt & echo nested> subdir\file.txt
<<<
>>>= 0

# ======================================================================
# SECTION 2: Scan treats subrepo as opaque boundary
# ======================================================================

# ---- bit add succeeds (scan doesn't crash on nested .git) ----
cd test\cli\output\work_scannested & bit add file.txt
<<<
>>>= 0

# ---- Cache exists for top-level file ----
if exist "test\cli\output\work_scannested\.bit\cache\file.txt" (echo cached) else (echo missing)
<<<
>>>
cached
>>>= 0

# ---- No cache entry for nested file (subdir is opaque boundary) ----
if exist "test\cli\output\work_scannested\.bit\cache\subdir\file.txt" (echo LEAKED) else (echo excluded)
<<<
>>>
excluded
>>>= 0

# ---- No cache entry for .git internals inside subdir ----
if exist "test\cli\output\work_scannested\.bit\cache\subdir\.git" (echo LEAKED) else (echo excluded)
<<<
>>>
excluded
>>>= 0

# ======================================================================
# SECTION 3: Commit works with top-level files only
# ======================================================================

# ---- Commit works (nested .git didn't pollute index) ----
cd test\cli\output\work_scannested & bit commit -m "test nested git"
<<<
>>> /\[main|master|files? changed/
>>>= 0

# ======================================================================
# CLEANUP
# ======================================================================

timeout /t 1 >nul & rmdir /s /q test\cli\output\work_scannested 2>nul & echo cleanup done
<<<
>>>
cleanup done
>>>= 0
