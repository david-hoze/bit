# bit verify tests â€” verify files match committed metadata (scan + git diff)

# --- verify on fresh repo: nothing to check ---
rmdir /s /q test\cli\output\work_verify 2>nul & mkdir test\cli\output\work_verify & cd test\cli\output\work_verify & bit init
<<<
>>> /.*[Ii]nitialized.*/
>>>= 0

cd test\cli\output\work_verify & bit verify
<<<
>>> /All.*0.*files match/
>>>= 0

# --- verify on repo with committed files: all OK ---
rmdir /s /q test\cli\output\work_verify 2>nul & mkdir test\cli\output\work_verify & cd test\cli\output\work_verify & bit init & echo hello> a.txt & bit add a.txt & bit commit -m "Add a"
<<<
>>> /.*[Ii]nitialized.*/
>>>= 0

cd test\cli\output\work_verify & bit verify
<<<
>>> /All.*files match/
>>>= 0

# --- verify detects corrupted binary file ---
rmdir /s /q test\cli\output\work_verify 2>nul & mkdir test\cli\output\work_verify & cd test\cli\output\work_verify & bit init & echo original> file.bin & bit add file.bin & bit commit -m "Add file"
<<<
>>> /.*[Ii]nitialized.*/
>>>= 0

cd test\cli\output\work_verify & echo corrupted> file.bin
<<<
>>>
>>>= 0

cd test\cli\output\work_verify & bit verify
<<<
>>> /issues found|hash mismatch|file\.bin/
>>>= 1

# --- verify detects corrupted file even after scan (stale metadata regression) ---
cd test\cli\output\work_verify & bit status
<<<
>>>= 0

cd test\cli\output\work_verify & bit verify
<<<
>>> /issues found|hash mismatch|file\.bin/
>>>= 1

# --- verify detects missing file ---
rmdir /s /q test\cli\output\work_verify 2>nul & mkdir test\cli\output\work_verify & cd test\cli\output\work_verify & bit init & echo x> missing.txt & bit add missing.txt & bit commit -m "Add missing"
<<<
>>> /.*[Ii]nitialized.*/
>>>= 0

del test\cli\output\work_verify\missing.txt
<<<
>>>
>>>= 0

cd test\cli\output\work_verify & bit verify
<<<
>>> /issues found|missing|missing\.txt/
>>>= 1

# --- cleanup ---
timeout /t 1 >nul & rmdir /s /q test\cli\output\work_verify 2>nul
<<<
>>>= 0
